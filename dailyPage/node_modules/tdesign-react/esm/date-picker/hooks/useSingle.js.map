{"version":3,"file":"useSingle.js","sources":["../../../src/date-picker/hooks/useSingle.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\nimport { CalendarIcon as TdCalendarIcon } from 'tdesign-icons-react';\nimport dayjs from 'dayjs';\nimport classNames from 'classnames';\nimport useConfig from '../../hooks/useConfig';\nimport useGlobalIcon from '../../hooks/useGlobalIcon';\nimport { TdDatePickerProps } from '../type';\nimport {\n  isValidDate,\n  formatDate,\n  formatTime,\n  getDefaultFormat,\n  parseToDayjs,\n} from '../../_common/js/date-picker/format';\nimport useSingleValue from './useSingleValue';\n\nexport default function useSingleInput(props: TdDatePickerProps) {\n  const { classPrefix, datePicker: globalDatePickerConfig } = useConfig();\n  const { CalendarIcon } = useGlobalIcon({ CalendarIcon: TdCalendarIcon });\n  const name = `${classPrefix}-date-picker`;\n\n  const { format, valueType, timeFormat } = getDefaultFormat({\n    mode: props.mode,\n    format: props.format,\n    valueType: props.valueType,\n    enableTimePicker: props.enableTimePicker,\n  });\n\n  const inputRef = useRef<HTMLInputElement>();\n\n  const { value, onChange, time, setTime, month, setMonth, year, setYear, cacheValue, setCacheValue } =\n    useSingleValue(props);\n\n  const [popupVisible, setPopupVisible] = useState(false);\n  const [isHoverCell, setIsHoverCell] = useState(false);\n  // 未真正选中前可能不断变更输入框的内容\n  const [inputValue, setInputValue] = useState(formatDate(value, { format }));\n\n  // input 设置\n  const inputProps = {\n    ...props.inputProps,\n    ref: inputRef,\n    clearable: props.clearable,\n    prefixIcon: props.prefixIcon,\n    readonly: !props.allowInput,\n    placeholder: props.placeholder ?? globalDatePickerConfig.placeholder[props.mode],\n    suffixIcon: props.suffixIcon ?? <CalendarIcon />,\n    className: classNames({\n      [`${name}__input--placeholder`]: isHoverCell,\n    }),\n    onClear: ({ e }) => {\n      e.stopPropagation();\n      setPopupVisible(false);\n      onChange('', { dayjsValue: dayjs(), trigger: 'clear' });\n    },\n    onBlur: (val: string, { e }) => {\n      props.onBlur?.({ value: val, e });\n    },\n    onFocus: (_: string, { e }) => {\n      props.onFocus?.({ value, e });\n    },\n    onChange: (val: string) => {\n      // 输入事件\n      setInputValue(val);\n\n      // 跳过不符合格式化的输入框内容\n      if (!isValidDate(val, format)) return;\n      const newMonth = dayjs(val).month();\n      const newYear = dayjs(val).year();\n      const newTime = formatTime(val, timeFormat);\n      !Number.isNaN(newYear) && setYear(newYear);\n      !Number.isNaN(newMonth) && setMonth(newMonth);\n      !Number.isNaN(newTime) && setTime(newTime);\n    },\n    onEnter: (val: string) => {\n      if (!val) {\n        onChange('', { dayjsValue: dayjs(), trigger: 'enter' });\n        setPopupVisible(false);\n        return;\n      }\n\n      if (!isValidDate(val, format) && !isValidDate(value, format)) return;\n\n      setPopupVisible(false);\n      if (isValidDate(val, format)) {\n        onChange(formatDate(val, { format, targetFormat: valueType }), {\n          dayjsValue: parseToDayjs(val, format),\n          trigger: 'enter',\n        });\n      } else if (isValidDate(value, format)) {\n        setInputValue(formatDate(value, { format }));\n      } else {\n        setInputValue('');\n      }\n    },\n  };\n\n  // popup 设置\n  const popupProps = {\n    expandAnimation: true,\n    ...props.popupProps,\n    overlayInnerStyle: props.popupProps?.overlayInnerStyle ?? { width: 'auto' },\n    overlayClassName: classNames(props.popupProps?.overlayClassName, `${name}__panel-container`),\n    onVisibleChange: (visible: boolean, context: any) => {\n      if (context.trigger === 'trigger-element-click') {\n        return setPopupVisible(true);\n      }\n      setPopupVisible(visible);\n    },\n  };\n\n  // 输入框响应 value 变化\n  useEffect(() => {\n    if (!value) {\n      setInputValue('');\n      return;\n    }\n    if (!isValidDate(value, format)) return;\n\n    setInputValue(formatDate(value, { format }));\n    // eslint-disable-next-line\n  }, [value]);\n\n  return {\n    year,\n    month,\n    value,\n    time,\n    inputValue,\n    popupVisible,\n    inputProps,\n    popupProps,\n    inputRef,\n    cacheValue,\n    onChange,\n    setYear,\n    setMonth,\n    setTime,\n    setIsHoverCell,\n    setInputValue,\n    setPopupVisible,\n    setCacheValue,\n  };\n}\n"],"names":["useSingleInput","props","useConfig","classPrefix","globalDatePickerConfig","datePicker","useGlobalIcon","CalendarIcon","TdCalendarIcon","name","getDefaultFormat","mode","format","valueType","enableTimePicker","timeFormat","inputRef","useRef","useSingleValue","value","onChange","time","setTime","month","setMonth","year","setYear","cacheValue","setCacheValue","useState","popupVisible","setPopupVisible","isHoverCell","setIsHoverCell","formatDate","inputValue","setInputValue","inputProps","ref","clearable","prefixIcon","readonly","allowInput","placeholder","suffixIcon","React","createElement","className","classNames","onClear","e","stopPropagation","dayjsValue","dayjs","trigger","onBlur","val","onFocus","_","isValidDate","newMonth","newYear","newTime","formatTime","Number","isNaN","onEnter","targetFormat","parseToDayjs","popupProps","expandAnimation","overlayInnerStyle","width","overlayClassName","onVisibleChange","visible","context","useEffect"],"mappings":"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"}