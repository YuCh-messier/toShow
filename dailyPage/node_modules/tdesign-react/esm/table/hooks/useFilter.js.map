{"version":3,"file":"useFilter.js","sources":["../../../src/table/hooks/useFilter.tsx"],"sourcesContent":["import React, { useEffect, useState, MutableRefObject } from 'react';\nimport isFunction from 'lodash/isFunction';\nimport useClassName from './useClassName';\nimport TButton from '../../button';\nimport { TdPrimaryTableProps, PrimaryTableCol, TableRowData, FilterValue } from '../type';\nimport useControlled from '../../hooks/useControlled';\nimport TableFilterController from '../FilterController';\nimport { useLocaleReceiver } from '../../locale/LocalReceiver';\n\nfunction isFilterValueExist(value: any) {\n  const isArrayTrue = value instanceof Array && value.length;\n  const isObject = typeof value === 'object' && !(value instanceof Array);\n  const isObjectTrue = isObject && Object.keys(value).length;\n  return isArrayTrue || isObjectTrue || !['null', '', 'undefined'].includes(String(value));\n}\n\n// 筛选条件不为空，才需要显示筛选结果行\nfunction filterEmptyData(data: FilterValue) {\n  const newFilterValue: FilterValue = {};\n  Object.keys(data).forEach((key) => {\n    const item = data[key];\n    if (isFilterValueExist(item)) {\n      newFilterValue[key] = item;\n    }\n  });\n  return newFilterValue;\n}\n\nexport default function useFilter(props: TdPrimaryTableProps, primaryTableRef: MutableRefObject<any>) {\n  const [locale, t] = useLocaleReceiver('table');\n  const { tableFilterClasses, isFocusClass } = useClassName();\n  const [isTableOverflowHidden, setIsTableOverflowHidden] = useState<boolean>();\n\n  // unControl and control\n  const [tFilterValue, setTFilterValue] = useControlled(props, 'filterValue', props.onFilterChange);\n\n  // 过滤内部值\n  const [innerFilterValue, setInnerFilterValue] = useState<FilterValue>(tFilterValue);\n\n  const hasEmptyCondition = (() => {\n    const filterEmpty = filterEmptyData(tFilterValue || {});\n    return !tFilterValue || !Object.keys(filterEmpty).length;\n  })();\n\n  useEffect(() => {\n    setInnerFilterValue(tFilterValue);\n  }, [tFilterValue]);\n\n  function renderFirstFilterRow() {\n    if (hasEmptyCondition) return null;\n    const defaultNode = (\n      <div className={tableFilterClasses.result}>\n        <span>\n          {/* 搜索 “{getFilterResultContent()}”， */}\n          {/* 找到 {props.pagination?.total || props.data?.length} 条结果 */}\n          {t(locale.searchResultText, {\n            result: getFilterResultContent(),\n            count: props.pagination?.total || props.data?.length,\n          })}\n        </span>\n        <TButton theme=\"primary\" variant=\"text\" onClick={onResetAll}>\n          {locale.clearFilterResultButtonText}\n        </TButton>\n      </div>\n    );\n    const filterContent = isFunction(props.filterRow) ? props.filterRow() : props.filterRow;\n    if (filterContent === null) return null;\n    const r = filterContent || defaultNode;\n    if (!r) return null;\n    return <div className={tableFilterClasses.inner}>{r}</div>;\n  }\n\n  // 获取搜索条件内容，存在 options 需要获取其 label 显示\n  function getFilterResultContent(): string {\n    const arr: string[] = [];\n    props.columns\n      .filter((col) => col.filter)\n      .forEach((col) => {\n        let value = tFilterValue[col.colKey];\n        if (col.filter.list && !['null', '', 'undefined'].includes(String(value))) {\n          const formattedValue = value instanceof Array ? value : [value];\n          const label: string[] = [];\n          col.filter.list.forEach((option) => {\n            if (formattedValue.includes(option.value)) {\n              label.push(option.label);\n            }\n          });\n          value = label.join();\n        }\n        if (isFilterValueExist(value)) {\n          arr.push(`${col.title}：${value}`);\n        }\n      });\n    return arr.join('；');\n  }\n\n  function onInnerFilterChange(val: any, column: PrimaryTableCol) {\n    const filterValue = {\n      ...innerFilterValue,\n      [column.colKey]: val,\n    };\n    setInnerFilterValue(filterValue);\n    if (!column.filter.showConfirmAndReset) {\n      emitFilterChange(filterValue, column);\n    }\n  }\n\n  function emitFilterChange(filterValue: FilterValue, column?: PrimaryTableCol) {\n    setTFilterValue(filterValue, { col: column });\n    props.onChange?.({ filter: filterValue }, { trigger: 'filter' });\n  }\n\n  function onReset(column: PrimaryTableCol) {\n    const filterValue: FilterValue = {\n      ...tFilterValue,\n      [column.colKey]:\n        {\n          single: '',\n          multiple: [],\n          input: '',\n        }[column.filter.type] ||\n        column.filter.resetValue ||\n        '',\n    };\n    emitFilterChange(filterValue, column);\n  }\n\n  function onResetAll() {\n    emitFilterChange({}, undefined);\n  }\n\n  function onConfirm(column: PrimaryTableCol) {\n    emitFilterChange(innerFilterValue, column);\n  }\n\n  // 图标：内置图标，组件自定义图标，全局配置图标\n  function renderFilterIcon({ col }: { col: PrimaryTableCol<TableRowData>; colIndex: number }) {\n    return (\n      <TableFilterController\n        column={col}\n        filterIcon={props.filterIcon}\n        tFilterValue={tFilterValue}\n        innerFilterValue={innerFilterValue}\n        tableFilterClasses={tableFilterClasses}\n        isFocusClass={isFocusClass}\n        onReset={onReset}\n        onConfirm={onConfirm}\n        onInnerFilterChange={onInnerFilterChange}\n        primaryTableElement={primaryTableRef?.current?.tableElement}\n        onVisibleChange={onPopupVisibleChange}\n      ></TableFilterController>\n    );\n  }\n\n  function onPopupVisibleChange(visible: boolean) {\n    if (visible && !isTableOverflowHidden) {\n      setIsTableOverflowHidden(!visible);\n    }\n  }\n\n  return {\n    hasEmptyCondition,\n    isTableOverflowHidden,\n    renderFilterIcon,\n    renderFirstFilterRow,\n  };\n}\n"],"names":["isFilterValueExist","value","isArrayTrue","Array","length","isObject","isObjectTrue","Object","keys","includes","String","filterEmptyData","data","newFilterValue","forEach","key","item","useFilter","props","primaryTableRef","useLocaleReceiver","locale","t","useClassName","tableFilterClasses","isFocusClass","useState","isTableOverflowHidden","setIsTableOverflowHidden","useControlled","onFilterChange","tFilterValue","setTFilterValue","innerFilterValue","setInnerFilterValue","hasEmptyCondition","filterEmpty","useEffect","renderFirstFilterRow","defaultNode","React","createElement","className","result","searchResultText","getFilterResultContent","count","pagination","total","TButton","theme","variant","onClick","onResetAll","clearFilterResultButtonText","filterContent","isFunction","filterRow","r","inner","arr","columns","filter","col","colKey","list","formattedValue","label","option","push","join","title","onInnerFilterChange","val","column","filterValue","showConfirmAndReset","emitFilterChange","onChange","trigger","onReset","single","multiple","input","type","resetValue","onConfirm","renderFilterIcon","TableFilterController","filterIcon","primaryTableElement","current","tableElement","onVisibleChange","onPopupVisibleChange","visible"],"mappings":"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"}