/**
 * tdesign v0.42.2
 * (c) 2022 tdesign
 * @license MIT
 */

'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var React = require('react');
var reactIs = require('react-is');
var classNames = require('classnames');
var hooks_useConfig = require('../../hooks/useConfig.js');
var popup_utils_ref = require('../utils/ref.js');
var _util_composeRefs = require('../../_util/composeRefs.js');
require('../../config-provider/ConfigContext.js');
require('../../_chunks/dep-3415b40f.js');
require('../../_chunks/dep-bbbce181.js');
require('../../_chunks/dep-4c1144f0.js');
require('../../_chunks/dep-be113066.js');
require('../../_chunks/dep-7affd9c7.js');
require('../../_chunks/dep-c15e2539.js');
require('../../_chunks/dep-1ad27019.js');
require('../../_chunks/dep-6c4c2f3e.js');
require('../../_chunks/dep-b282bced.js');
require('../../_chunks/dep-b8187df5.js');
require('../../_chunks/dep-6b7adfaa.js');
require('../../_chunks/dep-bdb568fa.js');
require('../../_chunks/dep-3c510ebe.js');
require('../../_chunks/dep-ffd983b8.js');
require('../../_chunks/dep-bafabd9b.js');
require('../../_chunks/dep-29ecaf93.js');
require('../../_chunks/dep-28bf72fc.js');
require('../../_chunks/dep-72f2b815.js');
require('../../_chunks/dep-46b250c3.js');
require('../../_chunks/dep-6f0ad8f9.js');
require('../../_chunks/dep-901b688e.js');
require('../../_chunks/dep-92d05577.js');
require('../../_chunks/dep-6aeda844.js');
require('../../_chunks/dep-39147135.js');
require('../../_common/js/global-config/locale/zh_CN.js');
require('../../_common/js/global-config/default-config.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);
var classNames__default = /*#__PURE__*/_interopDefaultLegacy(classNames);

var ESC_KEY = "Escape";
function useTrigger(_ref) {
  var content = _ref.content,
      disabled = _ref.disabled,
      trigger = _ref.trigger,
      visible = _ref.visible,
      onVisibleChange = _ref.onVisibleChange,
      triggerRef = _ref.triggerRef;

  var _useConfig = hooks_useConfig["default"](),
      classPrefix = _useConfig.classPrefix;

  var hasPopupMouseDown = React.useRef(false);
  var mouseDownTimer = React.useRef(0);
  var triggerDataKey = React.useRef("".concat(classPrefix, "-popup--").concat(Math.random().toFixed(10)));
  var shouldToggle = !disabled && content;
  React.useEffect(function () {
    if (!shouldToggle) return;

    var handleDocumentClick = function handleDocumentClick(e) {
      if (popup_utils_ref.getRefDom(triggerRef).contains(e.target) || hasPopupMouseDown.current) {
        return;
      }

      visible && onVisibleChange(false, {
        e: e,
        trigger: "document"
      });
    };

    document.addEventListener("mousedown", handleDocumentClick);
    document.addEventListener("touchend", handleDocumentClick);
    return function () {
      document.removeEventListener("mousedown", handleDocumentClick);
      document.removeEventListener("touchend", handleDocumentClick);
    };
  }, [shouldToggle, visible, onVisibleChange, triggerRef]);

  function getPopupProps() {
    if (!shouldToggle) return {};
    return {
      onMouseEnter: function onMouseEnter(e) {
        if (trigger === "hover") {
          onVisibleChange(true, {
            e: e,
            trigger: "trigger-element-hover"
          });
        }
      },
      onMouseLeave: function onMouseLeave(e) {
        if (trigger === "hover") {
          onVisibleChange(false, {
            e: e,
            trigger: "trigger-element-hover"
          });
        }
      },
      onMouseDown: function onMouseDown() {
        clearTimeout(mouseDownTimer.current);
        hasPopupMouseDown.current = true;
        mouseDownTimer.current = window.setTimeout(function () {
          hasPopupMouseDown.current = false;
        });
      },
      onTouchEnd: function onTouchEnd() {
        clearTimeout(mouseDownTimer.current);
        hasPopupMouseDown.current = true;
        mouseDownTimer.current = window.setTimeout(function () {
          hasPopupMouseDown.current = false;
        });
      }
    };
  }

  function getTriggerProps(triggerNode) {
    if (!shouldToggle) return {};
    var triggerProps = {
      className: visible ? classNames__default["default"](triggerNode.props.className, "".concat(classPrefix, "-popup-open")) : triggerNode.props.className,
      onClick: function onClick(e) {
        var _triggerNode$props$on, _triggerNode$props;

        if (trigger === "click") {
          onVisibleChange(!visible, {
            e: e,
            trigger: "trigger-element-click"
          });
        }

        (_triggerNode$props$on = (_triggerNode$props = triggerNode.props).onClick) === null || _triggerNode$props$on === void 0 ? void 0 : _triggerNode$props$on.call(_triggerNode$props, e);
      },
      onTouchStart: function onTouchStart(e) {
        var _triggerNode$props$on2, _triggerNode$props2;

        if (trigger === "hover") {
          onVisibleChange(true, {
            e: e,
            trigger: "trigger-element-hover"
          });
        }

        (_triggerNode$props$on2 = (_triggerNode$props2 = triggerNode.props).onTouchStart) === null || _triggerNode$props$on2 === void 0 ? void 0 : _triggerNode$props$on2.call(_triggerNode$props2, e);
      },
      onMouseEnter: function onMouseEnter(e) {
        var _triggerNode$props$on3, _triggerNode$props3;

        if (trigger === "hover") {
          onVisibleChange(true, {
            e: e,
            trigger: "trigger-element-hover"
          });
        }

        (_triggerNode$props$on3 = (_triggerNode$props3 = triggerNode.props).onMouseEnter) === null || _triggerNode$props$on3 === void 0 ? void 0 : _triggerNode$props$on3.call(_triggerNode$props3, e);
      },
      onMouseLeave: function onMouseLeave(e) {
        var _triggerNode$props$on4, _triggerNode$props4;

        if (trigger === "hover") {
          onVisibleChange(false, {
            e: e,
            trigger: "trigger-element-hover"
          });
        }

        (_triggerNode$props$on4 = (_triggerNode$props4 = triggerNode.props).onMouseLeave) === null || _triggerNode$props$on4 === void 0 ? void 0 : _triggerNode$props$on4.call(_triggerNode$props4, e);
      },
      onFocus: function onFocus() {
        var _triggerNode$props$on5, _triggerNode$props5;

        if (trigger === "focus") {
          onVisibleChange(true, {
            trigger: "trigger-element-focus"
          });
        }

        for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
          args[_key] = arguments[_key];
        }

        (_triggerNode$props$on5 = (_triggerNode$props5 = triggerNode.props).onFocus) === null || _triggerNode$props$on5 === void 0 ? void 0 : _triggerNode$props$on5.call.apply(_triggerNode$props$on5, [_triggerNode$props5].concat(args));
      },
      onBlur: function onBlur() {
        var _triggerNode$props$on6, _triggerNode$props6;

        if (trigger === "focus") {
          onVisibleChange(false, {
            trigger: "trigger-element-blur"
          });
        }

        for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
          args[_key2] = arguments[_key2];
        }

        (_triggerNode$props$on6 = (_triggerNode$props6 = triggerNode.props).onBlur) === null || _triggerNode$props$on6 === void 0 ? void 0 : _triggerNode$props$on6.call.apply(_triggerNode$props$on6, [_triggerNode$props6].concat(args));
      },
      onContextMenu: function onContextMenu(e) {
        var _triggerNode$props$on7, _triggerNode$props7;

        if (trigger === "context-menu") {
          onVisibleChange(true, {
            e: e,
            trigger: "context-menu"
          });
        }

        (_triggerNode$props$on7 = (_triggerNode$props7 = triggerNode.props).onContextMenu) === null || _triggerNode$props$on7 === void 0 ? void 0 : _triggerNode$props$on7.call(_triggerNode$props7, e);
      },
      onKeyDown: function onKeyDown(e) {
        var _triggerNode$props$on8, _triggerNode$props8;

        if ((e === null || e === void 0 ? void 0 : e.key) === ESC_KEY) {
          onVisibleChange(false, {
            e: e,
            trigger: "keydown-esc"
          });
        }

        (_triggerNode$props$on8 = (_triggerNode$props8 = triggerNode.props).onKeyDown) === null || _triggerNode$props$on8 === void 0 ? void 0 : _triggerNode$props$on8.call(_triggerNode$props8, e);
      }
    };

    if (popup_utils_ref.supportRef(triggerNode)) {
      triggerProps.ref = _util_composeRefs["default"](triggerRef, triggerNode.ref);
    } else {
      triggerProps["data-popup"] = triggerDataKey.current;
    }

    return triggerProps;
  }

  function getTriggerNode(children) {
    var triggerNode = /*#__PURE__*/React.isValidElement(children) && !reactIs.isFragment(children) ? children : /* @__PURE__ */React__default["default"].createElement("span", {
      className: "".concat(classPrefix, "-trigger")
    }, children);
    return /*#__PURE__*/React__default["default"].cloneElement(triggerNode, getTriggerProps(triggerNode));
  }

  function getTriggerDom() {
    return document.querySelector("[data-popup=\"".concat(triggerDataKey.current, "\"]"));
  }

  return {
    getTriggerNode: getTriggerNode,
    getPopupProps: getPopupProps,
    getTriggerDom: getTriggerDom
  };
}

exports["default"] = useTrigger;
//# sourceMappingURL=useTrigger.js.map
