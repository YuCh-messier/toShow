{"version":3,"file":"useSingle.js","sources":["../../../src/date-picker/hooks/useSingle.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\nimport { CalendarIcon as TdCalendarIcon } from 'tdesign-icons-react';\nimport dayjs from 'dayjs';\nimport classNames from 'classnames';\nimport useConfig from '../../hooks/useConfig';\nimport useGlobalIcon from '../../hooks/useGlobalIcon';\nimport { TdDatePickerProps } from '../type';\nimport {\n  isValidDate,\n  formatDate,\n  formatTime,\n  getDefaultFormat,\n  parseToDayjs,\n} from '../../_common/js/date-picker/format';\nimport useSingleValue from './useSingleValue';\n\nexport default function useSingleInput(props: TdDatePickerProps) {\n  const { classPrefix, datePicker: globalDatePickerConfig } = useConfig();\n  const { CalendarIcon } = useGlobalIcon({ CalendarIcon: TdCalendarIcon });\n  const name = `${classPrefix}-date-picker`;\n\n  const { format, valueType, timeFormat } = getDefaultFormat({\n    mode: props.mode,\n    format: props.format,\n    valueType: props.valueType,\n    enableTimePicker: props.enableTimePicker,\n  });\n\n  const inputRef = useRef<HTMLInputElement>();\n\n  const { value, onChange, time, setTime, month, setMonth, year, setYear, cacheValue, setCacheValue } =\n    useSingleValue(props);\n\n  const [popupVisible, setPopupVisible] = useState(false);\n  const [isHoverCell, setIsHoverCell] = useState(false);\n  // 未真正选中前可能不断变更输入框的内容\n  const [inputValue, setInputValue] = useState(formatDate(value, { format }));\n\n  // input 设置\n  const inputProps = {\n    ...props.inputProps,\n    ref: inputRef,\n    clearable: props.clearable,\n    prefixIcon: props.prefixIcon,\n    readonly: !props.allowInput,\n    placeholder: props.placeholder ?? globalDatePickerConfig.placeholder[props.mode],\n    suffixIcon: props.suffixIcon ?? <CalendarIcon />,\n    className: classNames({\n      [`${name}__input--placeholder`]: isHoverCell,\n    }),\n    onClear: ({ e }) => {\n      e.stopPropagation();\n      setPopupVisible(false);\n      onChange('', { dayjsValue: dayjs(), trigger: 'clear' });\n    },\n    onBlur: (val: string, { e }) => {\n      props.onBlur?.({ value: val, e });\n    },\n    onFocus: (_: string, { e }) => {\n      props.onFocus?.({ value, e });\n    },\n    onChange: (val: string) => {\n      // 输入事件\n      setInputValue(val);\n\n      // 跳过不符合格式化的输入框内容\n      if (!isValidDate(val, format)) return;\n      const newMonth = dayjs(val).month();\n      const newYear = dayjs(val).year();\n      const newTime = formatTime(val, timeFormat);\n      !Number.isNaN(newYear) && setYear(newYear);\n      !Number.isNaN(newMonth) && setMonth(newMonth);\n      !Number.isNaN(newTime) && setTime(newTime);\n    },\n    onEnter: (val: string) => {\n      if (!val) {\n        onChange('', { dayjsValue: dayjs(), trigger: 'enter' });\n        setPopupVisible(false);\n        return;\n      }\n\n      if (!isValidDate(val, format) && !isValidDate(value, format)) return;\n\n      setPopupVisible(false);\n      if (isValidDate(val, format)) {\n        onChange(formatDate(val, { format, targetFormat: valueType }), {\n          dayjsValue: parseToDayjs(val, format),\n          trigger: 'enter',\n        });\n      } else if (isValidDate(value, format)) {\n        setInputValue(formatDate(value, { format }));\n      } else {\n        setInputValue('');\n      }\n    },\n  };\n\n  // popup 设置\n  const popupProps = {\n    expandAnimation: true,\n    ...props.popupProps,\n    overlayInnerStyle: props.popupProps?.overlayInnerStyle ?? { width: 'auto' },\n    overlayClassName: classNames(props.popupProps?.overlayClassName, `${name}__panel-container`),\n    onVisibleChange: (visible: boolean, context: any) => {\n      if (context.trigger === 'trigger-element-click') {\n        return setPopupVisible(true);\n      }\n      setPopupVisible(visible);\n    },\n  };\n\n  // 输入框响应 value 变化\n  useEffect(() => {\n    if (!value) {\n      setInputValue('');\n      return;\n    }\n    if (!isValidDate(value, format)) return;\n\n    setInputValue(formatDate(value, { format }));\n    // eslint-disable-next-line\n  }, [value]);\n\n  return {\n    year,\n    month,\n    value,\n    time,\n    inputValue,\n    popupVisible,\n    inputProps,\n    popupProps,\n    inputRef,\n    cacheValue,\n    onChange,\n    setYear,\n    setMonth,\n    setTime,\n    setIsHoverCell,\n    setInputValue,\n    setPopupVisible,\n    setCacheValue,\n  };\n}\n"],"names":["useSingleInput","props","useConfig","classPrefix","globalDatePickerConfig","datePicker","useGlobalIcon","CalendarIcon","TdCalendarIcon","name","getDefaultFormat","mode","format","valueType","enableTimePicker","timeFormat","inputRef","useRef","useSingleValue","value","onChange","time","setTime","month","setMonth","year","setYear","cacheValue","setCacheValue","useState","_slicedToArray","popupVisible","setPopupVisible","isHoverCell","setIsHoverCell","formatDate","inputValue","setInputValue","inputProps","ref","clearable","prefixIcon","readonly","allowInput","placeholder","suffixIcon","React","createElement","className","classNames","_defineProperty","onClear","e","stopPropagation","dayjsValue","dayjs","trigger","onBlur","val","onFocus","_","isValidDate","newMonth","newYear","newTime","formatTime","Number","isNaN","onEnter","targetFormat","parseToDayjs","popupProps","expandAnimation","overlayInnerStyle","width","overlayClassName","onVisibleChange","visible","context","useEffect"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAgBA,SAAwBA,cAAxB,CAAuCC,KAAvC,EAAiE;AAAA,EAAA,IAAA,kBAAA,EAAA,iBAAA,EAAA,qBAAA,EAAA,iBAAA,EAAA,kBAAA,CAAA;;AAC/D,EAAA,IAAA,UAAA,GAA4DC,0BAAU,EAAtE;MAAQC,WAAR,cAAQA,WAAR;MAAiCC,sBAAjC,cAAqBC,UAArB,CAAA;;AACA,EAAA,IAAA,cAAA,GAAyBC,+BAAc;AAAEC,IAAAA,YAAA,EAAcC,8BAAAA;AAAhB,IAAvC;MAAQD,YAAR,kBAAQA,YAAR,CAAA;;EACA,IAAME,OAAUN,EAAAA,CAAAA,MAAAA,CAAAA,aAAhB,cAAA,CAAA,CAAA;;AAEA,EAAA,IAAA,iBAAA,GAA0CO,6CAAiB,CAAA;IACzDC,MAAMV,KAAM,CAAAU,IAD6C;IAEzDC,QAAQX,KAAM,CAAAW,MAF2C;IAGzDC,WAAWZ,KAAM,CAAAY,SAHwC;IAIzDC,kBAAkBb,KAAM,CAAAa,gBAAAA;AAJiC,GAAA,CAA3D;MAAQF,MAAR,qBAAQA,MAAR;MAAgBC,SAAhB,qBAAgBA,SAAhB;MAA2BE,UAA3B,qBAA2BA,UAA3B,CAAA;;EAOA,IAAMC,WAAWC,YAAyB,EAA1C,CAAA;;EAEA,IACEC,eAAAA,GAAAA,2CAAejB,MADjB;MAAQkB,KAAR,mBAAQA,KAAR;MAAeC,QAAf,mBAAeA,QAAf;MAAyBC,IAAzB,mBAAyBA,IAAzB;MAA+BC,OAA/B,mBAA+BA,OAA/B;MAAwCC,KAAxC,mBAAwCA,KAAxC;MAA+CC,QAA/C,mBAA+CA,QAA/C;MAAyDC,IAAzD,mBAAyDA,IAAzD;MAA+DC,OAA/D,mBAA+DA,OAA/D;MAAwEC,UAAxE,mBAAwEA,UAAxE;MAAoFC,aAApF,mBAAoFA,aAApF,CAAA;;EAGA,IAAwCC,SAAAA,GAAAA,eAAS,MAAjD;AAAA,MAAA,UAAA,GAAAC,4BAAA,CAAA,SAAA,EAAA,CAAA,CAAA;AAAA,MAAOC,YAAP,GAAA,UAAA,CAAA,CAAA,CAAA;AAAA,MAAqBC,eAArB,GAAA,UAAA,CAAA,CAAA,CAAA,CAAA;;EACA,IAAsCH,UAAAA,GAAAA,eAAS,MAA/C;AAAA,MAAA,UAAA,GAAAC,4BAAA,CAAA,UAAA,EAAA,CAAA,CAAA;AAAA,MAAOG,WAAP,GAAA,UAAA,CAAA,CAAA,CAAA;AAAA,MAAoBC,cAApB,GAAA,UAAA,CAAA,CAAA,CAAA,CAAA;;AAEM,EAAA,IAAA,UAAA,GAA8BL,cAAA,CAASM,wCAAWhB,OAAO;AAAEP,IAAAA,MAAO,EAAPA,MAAAA;AAAF,IAA3B,CAA9B;AAAA,MAAA,UAAA,GAAAkB,4BAAA,CAAA,UAAA,EAAA,CAAA,CAAA;AAAA,MAACM,UAAD,GAAA,UAAA,CAAA,CAAA,CAAA;AAAA,MAAaC,aAAb,GAAA,UAAA,CAAA,CAAA,CAAA,CAAA;;AAGN,EAAA,IAAMC,UAAa,GAAA,aAAA,CAAA,aAAA,CAAA,EAAA,EACdrC,KAAM,CAAAqC,UADQ,CAAA,EAAA,EAAA,EAAA;AAEjBC,IAAAA,GAAK,EAAAvB,QAFY;IAGjBwB,WAAWvC,KAAM,CAAAuC,SAHA;IAIjBC,YAAYxC,KAAM,CAAAwC,UAJD;AAKjBC,IAAAA,QAAA,EAAU,CAACzC,KAAM,CAAA0C,UALA;AAMjBC,IAAAA,WAAa,EAAA3C,CAAAA,kBAAAA,GAAAA,KAAA,CAAM2C,WAAN,MAAqBxC,IAAAA,IAAAA,kBAAAA,KAAAA,KAAAA,CAAAA,GAAAA,kBAAAA,GAAAA,sBAAA,CAAuBwC,WAAvB,CAAmC3C,KAAM,CAAAU,IAAzC,CANjB;AAOjBkC,IAAAA,UAAY,EAAA5C,CAAAA,iBAAAA,GAAAA,KAAA,CAAM4C,UAAN,MAAoB,IAAA,IAAA,iBAAA,KAAA,KAAA,CAAA,GAAA,iBAAA,kBAAAC,yBAAA,CAAAC,aAAA,CAACxC,YAAD,EAAc,IAAd,CAPf;AAQjByC,IAAAA,WAAWC,8BAAW,CAAAC,8BAAA,CAAA,EAAA,EAAA,EAAA,CAAA,MAAA,CAChBzC,IADgB,EAAA,sBAAA,CAAA,EACawB,WADb,CARL,CAAA;AAWjBkB,IAAAA,OAAS,EAAA,SAAW,OAAA,CAAA,IAAA,EAAA;MAAA,IAARC,CAAQ,QAARA,CAAQ,CAAA;AAClBA,MAAAA,CAAA,CAAEC,eAAF,EAAA,CAAA;MACArB,eAAA,CAAgB,KAAhB,CAAA,CAAA;MACAZ,QAAA,CAAS,EAAT,EAAa;QAAEkC,UAAA,EAAYC,2BAAd;AAAuBC,QAAAA,OAAA,EAAS,OAAA;AAAhC,OAAb,CAAA,CAAA;KAde;IAgBjBC,MAAQ,EAAA,SAACC,MAAAA,CAAAA,GAAD,EAAwB,KAAA,EAAA;AAAA,MAAA,IAAA,aAAA,CAAA;;MAAA,IAARN,CAAQ,SAARA,CAAQ,CAAA;AAC9B,MAAA,CAAA,aAAA,GAAAnD,KAAA,CAAMwD,MAAN,MAAA,IAAA,IAAA,aAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,aAAA,CAAA,IAAA,CAAAxD,KAAA,EAAe;AAAEkB,QAAAA,KAAO,EAAAuC,GAAT;AAAcN,QAAAA,GAAAA,CAAAA;AAAd,OAAf,CAAA,CAAA;KAjBe;IAmBjBO,OAAS,EAAA,SAACC,OAAAA,CAAAA,CAAD,EAAsB,KAAA,EAAA;AAAA,MAAA,IAAA,cAAA,CAAA;;MAAA,IAARR,CAAQ,SAARA,CAAQ,CAAA;AAC7B,MAAA,CAAA,cAAA,GAAAnD,KAAA,CAAM0D,OAAN,MAAA,IAAA,IAAA,cAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,cAAA,CAAA,IAAA,CAAA1D,KAAA,EAAgB;AAAEkB,QAAAA,KAAO,EAAPA,KAAF;AAASiC,QAAAA,CAAA,EAAAA,CAAAA;AAAT,OAAhB,CAAA,CAAA;KApBe;IAsBjBhC,QAAA,EAAU,SAACsC,QAAAA,CAAAA,GAAD,EAAiB;MAEzBrB,aAAA,CAAcqB,GAAd,CAAA,CAAA;AAGI,MAAA,IAAA,CAACG,wCAAY,CAAAH,GAAA,EAAK9C,MAAL,CAAb,EAA2B,OAAA;MAC/B,IAAMkD,QAAW,GAAAP,yBAAA,CAAMG,GAAN,CAAA,CAAWnC,KAAX,EAAjB,CAAA;MACA,IAAMwC,OAAU,GAAAR,yBAAA,CAAMG,GAAN,CAAA,CAAWjC,IAAX,EAAhB,CAAA;AACM,MAAA,IAAAuC,OAAA,GAAUC,uCAAW,CAAAP,GAAA,EAAK3C,UAAL,CAArB,CAAA;MACN,CAACmD,MAAO,CAAAC,KAAP,CAAaJ,OAAb,CAAD,IAA0BrC,QAAQqC,QAAlC,CAAA;MACA,CAACG,MAAO,CAAAC,KAAP,CAAaL,QAAb,CAAD,IAA2BtC,SAASsC,SAApC,CAAA;MACA,CAACI,MAAO,CAAAC,KAAP,CAAaH,OAAb,CAAD,IAA0B1C,QAAQ0C,QAAlC,CAAA;KAjCe;IAmCjBI,OAAA,EAAS,SAACV,OAAAA,CAAAA,GAAD,EAAiB;MACxB,IAAI,CAACA,GAAL,EAAU;QACRtC,QAAA,CAAS,EAAT,EAAa;UAAEkC,UAAA,EAAYC,2BAAd;AAAuBC,UAAAA,OAAA,EAAS,OAAA;AAAhC,SAAb,CAAA,CAAA;QACAxB,eAAA,CAAgB,KAAhB,CAAA,CAAA;AACA,QAAA,OAAA;AACF,OAAA;;AAEI,MAAA,IAAA,CAAC6B,yCAAYH,KAAK9C,OAAlB,IAA6B,CAACiD,wCAAA,CAAY1C,KAAZ,EAAmBP,MAAnB,CAA9B,EAA0D,OAAA;MAE9DoB,eAAA,CAAgB,KAAhB,CAAA,CAAA;;AACI,MAAA,IAAA6B,wCAAA,CAAYH,GAAZ,EAAiB9C,MAAjB,CAAA,EAA0B;AAC5BQ,QAAAA,QAAA,CAASe,wCAAWuB,KAAK;AAAE9C,UAAAA,QAAAA,MAAF;AAAUyD,UAAAA,YAAc,EAAAxD,SAAAA;AAAxB,UAAzB,EAA+D;AAC7DyC,UAAAA,UAAA,EAAYgB,yCAAa,CAAAZ,GAAA,EAAK9C,MAAL,CADoC;AAE7D4C,UAAAA,OAAS,EAAA,OAAA;AAFoD,SAA/D,CAAA,CAAA;OADE,MAKO,IAAAK,wCAAA,CAAY1C,KAAZ,EAAmBP,MAAnB,CAAA,EAA4B;AACrCyB,QAAAA,aAAA,CAAcF,uCAAW,CAAAhB,KAAA,EAAO;AAAEP,UAAAA,MAAA,EAAAA,MAAAA;AAAF,SAAP,CAAzB,CAAA,CAAA;AACK,OAFI,MAEJ;QACLyB,aAAA,CAAc,EAAd,CAAA,CAAA;AACF,OAAA;AACF,KAAA;GAvDF,CAAA,CAAA;;AA2DA,EAAA,IAAMkC,UAAa,GAAA,aAAA,CAAA,aAAA,CAAA;AACjBC,IAAAA,eAAiB,EAAA,IAAA;GACdvE,EAAAA,KAAM,CAAAsE,UAFQ,CAAA,EAAA,EAAA,EAAA;AAGjBE,IAAAA,iEAAmBxE,KAAM,CAAAsE,gBAAN,IAAA,IAAA,iBAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,iBAAA,CAAkBE,uBAAqB,IAAA,IAAA,qBAAA,KAAA,KAAA,CAAA,GAAA,qBAAA,GAAA;AAAEC,MAAAA,OAAO,MAAA;KAHlD;IAIjBC,kBAAkB1B,8BAAW,CAAA,CAAA,kBAAA,GAAAhD,KAAA,CAAMsE,UAAN,MAAA,IAAA,IAAA,kBAAA,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAAA,kBAAkBI,CAAAA,gBAAlB,EAAuClE,EAAAA,CAAAA,MAAAA,CAAAA,IAAvC,EAJZ,mBAAA,CAAA,CAAA;AAKjBmE,IAAAA,eAAA,EAAiB,SAAA,eAAA,CAACC,OAAD,EAAmBC,OAAnB,EAAoC;AAC/C,MAAA,IAAAA,OAAA,CAAQtB,OAAR,KAAoB,uBAApB,EAA6C;QAC/C,OAAOxB,gBAAgB,KAAvB,CAAA;AACF,OAAA;;MACAA,eAAA,CAAgB6C,OAAhB,CAAA,CAAA;AACF,KAAA;GAVF,CAAA,CAAA;;AAcAE,EAAAA,eAAA,CAAU,YAAM;IACd,IAAI,CAAC5D,KAAL,EAAY;MACVkB,aAAA,CAAc,EAAd,CAAA,CAAA;AACA,MAAA,OAAA;AACF,KAAA;;AACI,IAAA,IAAA,CAACwB,wCAAY,CAAA1C,KAAA,EAAOP,MAAP,CAAb,EAA6B,OAAA;AAEjCyB,IAAAA,aAAA,CAAcF,uCAAW,CAAAhB,KAAA,EAAO;AAAEP,MAAAA,MAAA,EAAAA,MAAAA;AAAF,KAAP,CAAzB,CAAA,CAAA;AAEF,GATA,EASG,CAACO,KAAD,CATH,CAAA,CAAA;EAWO,OAAA;AACLM,IAAAA,IAAA,EAAAA,IADK;AAELF,IAAAA,KAAA,EAAAA,KAFK;AAGLJ,IAAAA,KAAA,EAAAA,KAHK;AAILE,IAAAA,IAAA,EAAAA,IAJK;AAKLe,IAAAA,UAAA,EAAAA,UALK;AAMLL,IAAAA,YAAA,EAAAA,YANK;AAOLO,IAAAA,UAAA,EAAAA,UAPK;AAQLiC,IAAAA,UAAA,EAAAA,UARK;AASLvD,IAAAA,QAAA,EAAAA,QATK;AAULW,IAAAA,UAAA,EAAAA,UAVK;AAWLP,IAAAA,QAAA,EAAAA,QAXK;AAYLM,IAAAA,OAAA,EAAAA,OAZK;AAaLF,IAAAA,QAAA,EAAAA,QAbK;AAcLF,IAAAA,OAAA,EAAAA,OAdK;AAeLY,IAAAA,cAAA,EAAAA,cAfK;AAgBLG,IAAAA,aAAA,EAAAA,aAhBK;AAiBLL,IAAAA,eAAA,EAAAA,eAjBK;AAkBLJ,IAAAA,aAAA,EAAAA,aAAAA;GAlBK,CAAA;AAoBT;;;;"}