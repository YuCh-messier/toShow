{"version":3,"file":"useForm.js","sources":["../../../src/form/hooks/useForm.ts"],"sourcesContent":["import { useState, useRef } from 'react';\nimport type { NamePath } from '../type';\nimport type { WatchCallBack, InternalHooks, InternalFormInstance, Store } from './interface';\nimport log from '../../_common/js/log';\n\nexport const HOOK_MARK = Symbol('TD_FORM_INTERNAL_HOOKS');\n\n// TODO 后续将所有实例函数迁移到 FormStore 内统一管理\nclass FormStore {\n  private prevStore: Store = {};\n\n  private store: Store = {};\n\n  private forceRootUpdate: () => void;\n\n  constructor(forceRootUpdate: () => void) {\n    this.forceRootUpdate = forceRootUpdate;\n  }\n\n  public getForm = (): InternalFormInstance => ({\n    submit: null,\n    reset: null,\n    validate: null,\n    validateOnly: null,\n    clearValidate: null,\n    setFields: null,\n    setFieldsValue: null,\n    setValidateMessage: null,\n    getFieldValue: null,\n    getFieldsValue: null,\n    _init: true,\n\n    getInternalHooks: this.getInternalHooks,\n  });\n\n  private getInternalHooks = (key: Symbol): InternalHooks | null => {\n    if (key === HOOK_MARK) {\n      return {\n        notifyWatch: this.notifyWatch,\n        registerWatch: this.registerWatch,\n        getPrevStore: () => this.prevStore,\n        setPrevStore: (store: object) => {\n          this.prevStore = store;\n        },\n      };\n    }\n\n    log.warn('Form', '`getInternalHooks` is internal usage. Should not call directly.');\n    return null;\n  };\n\n  private watchList: WatchCallBack[] = [];\n\n  private registerWatch: InternalHooks['registerWatch'] = (callback) => {\n    this.watchList.push(callback);\n\n    return () => {\n      this.watchList = this.watchList.filter((fn) => fn !== callback);\n    };\n  };\n\n  private notifyWatch = (namePath: NamePath = []) => {\n    // No need to cost perf when nothing need to watch\n    if (this.watchList.length) {\n      const values = this.getFieldsValue?.(namePath);\n\n      this.watchList.forEach((callback) => {\n        callback(values, namePath);\n      });\n    }\n  };\n\n  // TODO 暂时先从组件初始化时外部 merge 覆盖相关 form 操作函数\n  private getFieldsValue = null;\n}\n\nexport default function useForm(form?: InternalFormInstance) {\n  const formRef = useRef<InternalFormInstance>({});\n  const [, forceUpdate] = useState({});\n\n  // eslint-disable-next-line\n  if (!formRef.current._init) {\n    if (form) {\n      formRef.current = form;\n    } else {\n      // Create a new FormStore if not provided\n      const forceReRender = () => {\n        forceUpdate({});\n      };\n\n      const formStore: FormStore = new FormStore(forceReRender);\n\n      formRef.current = formStore.getForm();\n    }\n  }\n\n  return [formRef.current];\n}\n"],"names":["HOOK_MARK","Symbol","FormStore","forceRootUpdate","submit","reset","validate","validateOnly","clearValidate","setFields","setFieldsValue","setValidateMessage","getFieldValue","getFieldsValue","_init","getInternalHooks","key","notifyWatch","registerWatch","getPrevStore","prevStore","setPrevStore","store","log","warn","callback","watchList","push","filter","fn","namePath","length","values","forEach","useForm","form","formRef","useRef","useState","forceUpdate","current","forceReRender","formStore","getForm"],"mappings":"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"}