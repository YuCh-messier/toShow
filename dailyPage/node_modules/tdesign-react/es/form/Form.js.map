{"version":3,"file":"Form.js","sources":["../../src/form/Form.tsx"],"sourcesContent":["import React, { useRef, useImperativeHandle } from 'react';\nimport classNames from 'classnames';\nimport useConfig from '../hooks/useConfig';\nimport noop from '../_util/noop';\nimport forwardRefWithStatics from '../_util/forwardRefWithStatics';\nimport type { TdFormProps } from './type';\nimport type { InternalFormInstance } from './hooks/interface';\nimport useInstance from './hooks/useInstance';\nimport useForm, { HOOK_MARK } from './hooks/useForm';\nimport useWatch from './hooks/useWatch';\nimport { StyledProps } from '../common';\nimport FormContext from './FormContext';\nimport FormItem from './FormItem';\nimport FormList from './FormList';\nimport { formDefaultProps } from './defaultProps';\n\nexport interface FormProps extends TdFormProps, StyledProps {\n  children?: React.ReactNode;\n}\n\nconst Form = forwardRefWithStatics(\n  (props: FormProps, ref) => {\n    const { classPrefix, form: globalFormConfig } = useConfig();\n\n    const {\n      style,\n      className,\n      labelWidth,\n      statusIcon,\n      labelAlign,\n      layout,\n      colon,\n      initialData,\n      requiredMark = globalFormConfig.requiredMark,\n      scrollToFirstError,\n      showErrorMessage,\n      resetType,\n      rules,\n      errorMessage = globalFormConfig.errorMessage,\n      preventSubmitDefault,\n      disabled,\n      children,\n      onReset,\n      onValuesChange = noop,\n    } = props;\n\n    const formClass = classNames(`${classPrefix}-form`, className, {\n      [`${classPrefix}-form-inline`]: layout === 'inline',\n    });\n\n    const [form] = useForm(props.form); // 内部与外部共享 form 实例，外部不传则内部创建\n    const formRef: React.RefObject<HTMLFormElement> = useRef();\n    const formMapRef = useRef(new Map()); // 收集所有包含 name 属性 formItem 实例\n    const formInstance = useInstance(props, formRef, formMapRef);\n\n    useImperativeHandle(ref, () => formInstance);\n    Object.assign(form, { ...formInstance });\n\n    function onResetHandler(e: React.FormEvent<HTMLFormElement>) {\n      [...formMapRef.current.values()].forEach((formItemRef) => {\n        formItemRef?.current.resetField();\n      });\n      (form as InternalFormInstance)?.getInternalHooks?.(HOOK_MARK).notifyWatch?.([]);\n      onReset?.({ e });\n    }\n\n    function onFormItemValueChange(changedValue: Record<string, unknown>) {\n      const allFields = formInstance.getFieldsValue(true);\n      onValuesChange(changedValue, allFields);\n    }\n\n    function onKeyDownHandler(e: React.KeyboardEvent<HTMLFormElement>) {\n      // 禁用 input 输入框回车自动提交 form\n      if ((e.target as Element).tagName.toLowerCase() !== 'input') return;\n      if (preventSubmitDefault && e.key === 'Enter') {\n        e.preventDefault?.();\n        e.stopPropagation?.();\n      }\n    }\n\n    return (\n      <FormContext.Provider\n        value={{\n          form,\n          labelWidth,\n          statusIcon,\n          labelAlign,\n          layout,\n          colon,\n          initialData,\n          requiredMark,\n          errorMessage,\n          showErrorMessage,\n          scrollToFirstError,\n          resetType,\n          rules,\n          disabled,\n          formMapRef,\n          onFormItemValueChange,\n        }}\n      >\n        <form\n          ref={formRef}\n          style={style}\n          className={formClass}\n          onSubmit={formInstance.submit}\n          onReset={onResetHandler}\n          onKeyDown={onKeyDownHandler}\n        >\n          {children}\n        </form>\n      </FormContext.Provider>\n    );\n  },\n  { useForm, useWatch, FormItem, FormList },\n);\n\nForm.displayName = 'Form';\nForm.defaultProps = formDefaultProps;\n\nexport default Form;\n"],"names":["Form","forwardRefWithStatics","props","ref","useConfig","classPrefix","globalFormConfig","form","style","className","labelWidth","statusIcon","labelAlign","layout","colon","initialData","requiredMark","scrollToFirstError","showErrorMessage","resetType","rules","errorMessage","preventSubmitDefault","disabled","children","onReset","onValuesChange","noop","formClass","classNames","useForm","formRef","useRef","formMapRef","Map","formInstance","useInstance","useImperativeHandle","Object","assign","onResetHandler","e","current","values","forEach","formItemRef","resetField","getInternalHooks","HOOK_MARK","notifyWatch","onFormItemValueChange","changedValue","allFields","getFieldsValue","onKeyDownHandler","target","tagName","toLowerCase","key","preventDefault","stopPropagation","React","createElement","FormContext","Provider","value","onSubmit","submit","onKeyDown","useWatch","FormItem","FormList","displayName","defaultProps","formDefaultProps"],"mappings":"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"}